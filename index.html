<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vegas Trip Planner</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            min-height: 100vh;
            color: #fff;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            text-align: center;
            padding: 40px 0;
        }

        header h1 {
            font-size: 3rem;
            background: linear-gradient(90deg, #f9d423, #ff4e50);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 10px;
        }

        header p {
            color: #aaa;
            font-size: 1.1rem;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 16px;
            padding: 24px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .card h2 {
            font-size: 1.4rem;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .card h2 span {
            font-size: 1.5rem;
        }

        input, select, textarea {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
            font-size: 1rem;
            margin-bottom: 12px;
        }

        input::placeholder, textarea::placeholder {
            color: rgba(255, 255, 255, 0.5);
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #f9d423;
        }

        button {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        button:hover {
            transform: translateY(-2px);
        }

        .btn-primary {
            background: linear-gradient(90deg, #f9d423, #ff4e50);
            color: #1a1a2e;
            font-weight: 600;
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .btn-danger {
            background: #e74c3c;
            color: #fff;
            padding: 6px 12px;
            font-size: 0.85rem;
        }

        .friend-list, .expense-list, .activity-list {
            list-style: none;
            margin-top: 16px;
        }

        .friend-list li, .expense-list li, .activity-list li {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            margin-bottom: 8px;
        }

        .friend-list li .name {
            font-weight: 500;
        }

        .crew-list {
            list-style: none;
            margin-top: 16px;
        }

        .crew-list li {
            padding: 12px 16px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            margin-bottom: 8px;
        }

        .crew-list li .crew-name {
            font-weight: 600;
            margin-bottom: 4px;
        }

        .crew-list li .crew-detail {
            font-size: 0.9rem;
            color: #aaa;
            margin-top: 4px;
        }

        .expense-list li {
            flex-direction: column;
            align-items: flex-start;
            gap: 8px;
        }

        .expense-header {
            display: flex;
            justify-content: space-between;
            width: 100%;
            align-items: center;
        }

        .expense-details {
            font-size: 0.9rem;
            color: #aaa;
        }

        .expense-amount {
            font-size: 1.2rem;
            font-weight: 600;
            color: #2ecc71;
        }

        .balance-card {
            grid-column: 1 / -1;
        }

        .balance-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 16px;
            margin-top: 16px;
        }

        .balance-item {
            background: rgba(255, 255, 255, 0.05);
            padding: 16px;
            border-radius: 8px;
            text-align: center;
        }

        .balance-item .person {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .balance-item .amount {
            font-size: 1.5rem;
            font-weight: 700;
        }

        .balance-item .amount.positive {
            color: #2ecc71;
        }

        .balance-item .amount.negative {
            color: #e74c3c;
        }

        .balance-item .amount.zero {
            color: #f9d423;
        }

        .settlements {
            margin-top: 24px;
            padding-top: 24px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .settlements h3 {
            margin-bottom: 16px;
            color: #f9d423;
        }

        .settlement-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            background: rgba(46, 204, 113, 0.1);
            border-radius: 8px;
            margin-bottom: 8px;
            border-left: 4px solid #2ecc71;
        }

        .settlement-item .arrow {
            color: #2ecc71;
            font-weight: bold;
        }

        .checkbox-group {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 12px;
        }

        .checkbox-group label {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 8px 12px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 6px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .checkbox-group label:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .checkbox-group input[type="checkbox"] {
            width: auto;
            margin: 0;
        }

        .activity-item {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .activity-item .activity-name {
            font-weight: 500;
        }

        .activity-item .activity-date {
            font-size: 0.85rem;
            color: #aaa;
        }

        .activity-item .activity-notes {
            font-size: 0.9rem;
            color: #ccc;
            font-style: italic;
        }

        .empty-state {
            text-align: center;
            padding: 24px;
            color: #666;
        }

        .input-row {
            display: flex;
            gap: 12px;
        }

        .input-row input {
            flex: 1;
        }

        .total-spent {
            text-align: center;
            padding: 20px;
            background: linear-gradient(90deg, rgba(249, 212, 35, 0.1), rgba(255, 78, 80, 0.1));
            border-radius: 12px;
            margin-bottom: 20px;
        }

        .total-spent .label {
            font-size: 0.9rem;
            color: #aaa;
            margin-bottom: 4px;
        }

        .total-spent .value {
            font-size: 2.5rem;
            font-weight: 700;
            background: linear-gradient(90deg, #f9d423, #ff4e50);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        @media (max-width: 768px) {
            header h1 {
                font-size: 2rem;
            }

            .grid {
                grid-template-columns: 1fr;
            }

            .input-row {
                flex-direction: column;
            }
        }

        /* Trip landing + header meta */
        .screen {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .landing-wrap {
            width: 100%;
            max-width: 860px;
        }

        .landing-title {
            text-align: center;
            margin-bottom: 20px;
        }

        .landing-title h1 {
            font-size: 3rem;
            background: linear-gradient(90deg, #f9d423, #ff4e50);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 10px;
        }

        .landing-title p {
            color: #aaa;
            font-size: 1.05rem;
        }

        .landing-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 16px;
        }

        .muted {
            color: #aaa;
            font-size: 0.95rem;
        }

        .error {
            margin-top: 10px;
            background: rgba(231, 76, 60, 0.12);
            border: 1px solid rgba(231, 76, 60, 0.35);
            color: #ffd7d3;
            padding: 10px 12px;
            border-radius: 8px;
            display: none;
        }

        .trip-meta {
            margin-top: 14px;
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 10px;
        }

        .pill {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            border-radius: 999px;
            background: rgba(255, 255, 255, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.14);
            color: #fff;
            font-size: 0.95rem;
        }

        .pill code {
            font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
            letter-spacing: 0.08em;
            font-weight: 700;
        }

        .btn-small {
            padding: 8px 12px;
            font-size: 0.95rem;
        }

        .modal {
            position: fixed;
            inset: 0;
            z-index: 100;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal-backdrop {
            position: absolute;
            inset: 0;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(4px);
        }

        .modal-content {
            position: relative;
            width: 100%;
            max-width: 420px;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-actions {
            display: flex;
            gap: 12px;
            margin-top: 8px;
        }

        .modal-actions .btn-primary {
            flex: 1;
        }

        .crew-list li .crew-item-actions {
            display: flex;
            gap: 8px;
            margin-top: 10px;
        }

        .crew-list li .crew-item-actions button {
            padding: 6px 12px;
            font-size: 0.85rem;
        }
    </style>
</head>
<body>
    <!-- Landing screen (Create/Join Trip) -->
    <div id="landingRoot" class="screen">
        <div class="landing-wrap">
            <div class="landing-title">
                <h1>Vegas Trip Planner</h1>
                <p>Create a trip or join with a code to get started.</p>
            </div>

            <div class="landing-grid">
                <div class="card">
                    <h2><span>‚ú®</span> Create Trip</h2>
                    <input id="createTripName" type="text" placeholder="Trip name (e.g., Vegas 2026)">
                    <button id="createTripBtn" class="btn-primary" style="width: 100%;">Create Trip</button>
                    <div class="muted" style="margin-top: 10px;">
                        You‚Äôll get a 6-character code to share with friends.
                    </div>
                </div>

                <div class="card">
                    <h2><span>üîë</span> Join Trip</h2>
                    <input id="joinTripCode" type="text" placeholder="Enter code (e.g., A1B2C3)" maxlength="12" autocapitalize="characters" spellcheck="false">
                    <button id="joinTripBtn" class="btn-secondary" style="width: 100%;">Join Trip</button>
                    <div class="muted" style="margin-top: 10px;">
                        Codes are not case-sensitive.
                    </div>
                </div>
            </div>

            <div id="landingError" class="error"></div>
        </div>
    </div>

    <!-- Join preview: show existing crew and choose "already a member" or "join as new" -->
    <div id="joinPreviewRoot" class="screen" style="display: none;">
        <div class="landing-wrap">
            <div class="landing-title">
                <h1 id="joinPreviewTripName">‚Äî</h1>
                <p class="muted">Code: <code id="joinPreviewTripCode">------</code></p>
            </div>
            <div class="card" style="max-width: 480px; margin: 0 auto;">
                <h2 style="font-size: 1.2rem; margin-bottom: 12px;">Who‚Äôs on this trip</h2>
                <ul class="crew-list" id="joinPreviewCrewList">
                    <li class="empty-state">Loading‚Ä¶</li>
                </ul>
                <div style="margin-top: 20px; display: flex; flex-direction: column; gap: 12px;">
                    <button type="button" class="btn-primary" onclick="joinAsExistingMember()">I'm already a member</button>
                    <button type="button" class="btn-secondary" onclick="joinAsNewMember()">Join as new member</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Crew sign-up form (shown when joining or creating a trip, before entering the app) -->
    <div id="crewFormRoot" class="screen" style="display: none;">
        <div class="landing-wrap">
            <div class="landing-title">
                <h1 id="crewFormTitle">Add yourself to the crew</h1>
                <p>Add your travel details for this trip.</p>
            </div>
            <div class="card" style="max-width: 480px; margin: 0 auto;">
                <form id="crewForm">
                    <input id="crewName" type="text" placeholder="Your name" required>
                    <input id="crewEmail" type="email" placeholder="Email" required>
                    <input id="crewArrivalFlight" type="text" placeholder="Arrival flight (e.g. AA 123)">
                    <input id="crewArrivalDatetime" type="datetime-local" placeholder="Arrival date & time">
                    <input id="crewDepartureFlight" type="text" placeholder="Departure flight (e.g. AA 456)">
                    <input id="crewDepartureDatetime" type="datetime-local" placeholder="Departure date & time">
                    <div id="crewFormError" class="error" style="margin-bottom: 12px;"></div>
                    <button type="submit" id="crewFormSubmit" class="btn-primary" style="width: 100%;">Save & Enter Trip</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Main app (shown after trip is selected) -->
    <div id="appRoot" style="display: none;">
        <div class="container">
            <header>
                <h1>Vegas Trip Planner</h1>
                <p>Plan your trip and split expenses fairly</p>
                <div class="trip-meta">
                    <span class="pill">Trip: <strong id="tripNameDisplay">‚Äî</strong></span>
                    <span class="pill">Code: <code id="tripCodeDisplay">------</code></span>
                    <button class="btn-secondary btn-small" onclick="switchTrip()">Switch Trip</button>
                </div>
            </header>

            <div class="grid">
                <!-- Crew Section -->
                <div class="card">
                    <h2><span>‚úàÔ∏è</span> Crew</h2>
                    <p class="muted" style="margin-bottom: 12px; font-size: 0.9rem;">Trip members and their flight details. Expense splitting uses crew members.</p>
                    <button type="button" class="btn-secondary" style="margin-bottom: 16px;" onclick="openCrewMemberModal()">Add Crew Member</button>
                    <ul class="crew-list" id="crewList">
                        <li class="empty-state">Loading crew‚Ä¶</li>
                    </ul>
                </div>

                <!-- Activities Section -->
                <div class="card">
                    <h2><span>üé∞</span> Activities</h2>
                    <input type="text" id="activityName" placeholder="Activity name (e.g., Cirque du Soleil)">
                    <div class="input-row">
                        <input type="date" id="activityDate">
                        <input type="time" id="activityTime">
                    </div>
                    <textarea id="activityNotes" placeholder="Notes (optional)" rows="2"></textarea>
                    <button class="btn-primary" onclick="addActivity()">Add Activity</button>
                    <ul class="activity-list" id="activityList">
                        <li class="empty-state">No activities planned yet</li>
                    </ul>
                </div>

                <!-- Expenses Section -->
                <div class="card">
                    <h2><span>üí∞</span> Add Expense</h2>
                    <input type="text" id="expenseDesc" placeholder="What was it for? (e.g., Hotel, Show tickets)">
                    <input type="number" id="expenseAmount" placeholder="Amount ($)" step="0.01">
                    <select id="expensePayer">
                        <option value="">Who paid?</option>
                    </select>
                    <p style="margin-bottom: 8px; color: #aaa; font-size: 0.9rem;">Split between:</p>
                    <div class="checkbox-group" id="splitBetween"></div>
                    <button class="btn-primary" onclick="addExpense()">Add Expense</button>
                </div>

                <!-- Expense List -->
                <div class="card">
                    <h2><span>üìã</span> Expenses</h2>
                    <ul class="expense-list" id="expenseList">
                        <li class="empty-state">No expenses recorded yet</li>
                    </ul>
                </div>

                <!-- Balance Section -->
                <div class="card balance-card">
                    <h2><span>‚öñÔ∏è</span> Balances</h2>
                    <div class="total-spent">
                        <div class="label">Total Trip Cost</div>
                        <div class="value" id="totalSpent">$0.00</div>
                    </div>
                    <div class="balance-grid" id="balanceGrid">
                        <div class="empty-state">Add crew and expenses to see balances</div>
                    </div>
                    <div class="settlements" id="settlements" style="display: none;">
                        <h3>How to Settle Up</h3>
                        <div id="settlementList"></div>
                    </div>
                </div>
            </div>

            <!-- Add/Edit Crew Member Modal -->
            <div id="crewMemberModal" class="modal" style="display: none;">
                <div class="modal-backdrop" onclick="closeCrewMemberModal()"></div>
                <div class="modal-content card">
                    <h2><span>‚úàÔ∏è</span> <span id="crewModalTitle">Add Crew Member</span></h2>
                    <form id="crewMemberForm" onsubmit="saveCrewMember(); return false;">
                        <input type="hidden" id="crewMemberId" value="">
                        <input id="modalCrewName" type="text" placeholder="Name" required>
                        <input id="modalCrewEmail" type="email" placeholder="Email" required>
                        <input id="modalCrewArrivalFlight" type="text" placeholder="Arrival flight (e.g. AA 123)">
                        <input id="modalCrewArrivalDatetime" type="datetime-local" placeholder="Arrival date & time">
                        <input id="modalCrewDepartureFlight" type="text" placeholder="Departure flight (e.g. AA 456)">
                        <input id="modalCrewDepartureDatetime" type="datetime-local" placeholder="Departure date & time">
                        <div id="crewMemberModalError" class="error" style="margin-bottom: 12px;"></div>
                        <div class="modal-actions">
                            <button type="button" class="btn-secondary" onclick="closeCrewMemberModal()">Cancel</button>
                            <button type="submit" id="crewMemberModalSubmit" class="btn-primary">Save</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        // -----------------------------
        // Supabase + Trip gating
        // -----------------------------
        const SUPABASE_URL = 'https://sxjtepymbfqvcuzdsycj.supabase.co';
        const SUPABASE_ANON_KEY = 'sb_publishable_2d9L28Wc3gz7-u2jCIGU0A_bNrdJs9r';
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        const CURRENT_TRIP_STORAGE_KEY = 'vegas_current_trip';
        const CODE_ALPHABET = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
        let currentTrip = null;
        let storageKeyPrefix = null;
        let pendingJoinTrip = null;

        function normalizeTripCode(input) {
            return String(input || '').trim().toUpperCase().replace(/\s+/g, '');
        }

        function generateTripCode() {
            const bytes = new Uint8Array(6);
            crypto.getRandomValues(bytes);
            let out = '';
            for (let i = 0; i < bytes.length; i++) {
                out += CODE_ALPHABET[bytes[i] % CODE_ALPHABET.length];
            }
            return out;
        }

        function setLandingError(message) {
            const el = document.getElementById('landingError');
            if (!el) return;
            if (!message) {
                el.style.display = 'none';
                el.textContent = '';
                return;
            }
            el.style.display = 'block';
            el.textContent = message;
        }

        function setBusy(btn, busy, busyText = 'Working...') {
            if (!btn) return;
            btn.disabled = !!busy;
            btn.dataset._prevText = btn.dataset._prevText || btn.textContent;
            btn.textContent = busy ? busyText : btn.dataset._prevText;
        }

        function persistCurrentTrip(tripRow) {
            currentTrip = tripRow;
            storageKeyPrefix = `vegas_${currentTrip.trip_code}_`;
            localStorage.setItem(CURRENT_TRIP_STORAGE_KEY, JSON.stringify({
                id: tripRow.id,
                trip_code: tripRow.trip_code,
                trip_name: tripRow.trip_name
            }));
        }

        function readPersistedTrip() {
            try {
                const raw = localStorage.getItem(CURRENT_TRIP_STORAGE_KEY);
                if (!raw) return null;
                const parsed = JSON.parse(raw);
                if (!parsed || !parsed.trip_code) return null;
                return parsed;
            } catch {
                return null;
            }
        }

        function clearPersistedTrip() {
            localStorage.removeItem(CURRENT_TRIP_STORAGE_KEY);
            currentTrip = null;
            storageKeyPrefix = null;
        }

        function showLanding() {
            setLandingError('');
            document.getElementById('landingRoot').style.display = 'flex';
            document.getElementById('appRoot').style.display = 'none';
            document.getElementById('joinPreviewRoot').style.display = 'none';
            document.getElementById('crewFormRoot').style.display = 'none';
            pendingJoinTrip = null;
        }

        async function showJoinPreview(tripRow) {
            pendingJoinTrip = tripRow;
            document.getElementById('landingRoot').style.display = 'none';
            document.getElementById('appRoot').style.display = 'none';
            document.getElementById('joinPreviewRoot').style.display = 'flex';
            document.getElementById('crewFormRoot').style.display = 'none';

            document.getElementById('joinPreviewTripName').textContent = tripRow.trip_name || '‚Äî';
            document.getElementById('joinPreviewTripCode').textContent = tripRow.trip_code || '------';

            const listEl = document.getElementById('joinPreviewCrewList');
            listEl.innerHTML = '<li class="empty-state">Loading‚Ä¶</li>';
            try {
                const crew = await fetchCrewForTrip(tripRow.trip_code);
                if (!crew.length) {
                    listEl.innerHTML = '<li class="empty-state">No crew members yet.</li>';
                } else {
                    listEl.innerHTML = crew.map(c => `
                        <li>
                            <div class="crew-name">${escapeHtml(c.name)}</div>
                            <div class="crew-detail">${escapeHtml(c.email)}</div>
                        </li>
                    `).join('');
                }
            } catch {
                listEl.innerHTML = '<li class="empty-state">Could not load crew list.</li>';
            }
        }

        function hideJoinPreview() {
            document.getElementById('joinPreviewRoot').style.display = 'none';
        }

        async function fetchCrewForTrip(tripCode) {
            if (!tripCode) return [];
            const { data, error } = await supabaseClient
                .from('crew')
                .select('name, email')
                .eq('trip_code', tripCode)
                .order('name');
            if (error) throw error;
            return data || [];
        }

        function joinAsExistingMember() {
            if (!pendingJoinTrip) return;
            hideJoinPreview();
            enterTrip(pendingJoinTrip);
            showApp();
        }

        function joinAsNewMember() {
            if (!pendingJoinTrip) return;
            hideJoinPreview();
            showCrewForm(pendingJoinTrip, false);
        }

        function showCrewForm(tripRow, isCreate) {
            pendingJoinTrip = tripRow;
            document.getElementById('landingRoot').style.display = 'none';
            document.getElementById('appRoot').style.display = 'none';
            document.getElementById('joinPreviewRoot').style.display = 'none';
            document.getElementById('crewFormRoot').style.display = 'flex';
            const titleEl = document.getElementById('crewFormTitle');
            if (titleEl) titleEl.textContent = isCreate ? 'Add yourself to the crew' : 'Join the crew';
            setCrewFormError('');
            document.getElementById('crewForm').reset();
        }

        function hideCrewForm() {
            document.getElementById('crewFormRoot').style.display = 'none';
            pendingJoinTrip = null;
        }

        function setCrewFormError(message) {
            const el = document.getElementById('crewFormError');
            if (!el) return;
            if (!message) {
                el.style.display = 'none';
                el.textContent = '';
                return;
            }
            el.style.display = 'block';
            el.textContent = message;
        }

        function showApp() {
            document.getElementById('landingRoot').style.display = 'none';
            document.getElementById('joinPreviewRoot').style.display = 'none';
            document.getElementById('crewFormRoot').style.display = 'none';
            document.getElementById('appRoot').style.display = 'block';

            document.getElementById('tripNameDisplay').textContent = currentTrip?.trip_name || '‚Äî';
            document.getElementById('tripCodeDisplay').textContent = currentTrip?.trip_code || '------';
            loadCrew();
        }

        async function createTrip(tripName) {
            const name = String(tripName || '').trim() || 'Vegas Trip';

            // Retry on rare collisions against unique constraint.
            for (let attempt = 0; attempt < 10; attempt++) {
                const code = generateTripCode();
                const { data, error } = await supabaseClient
                    .from('trips')
                    .insert({ trip_code: code, trip_name: name })
                    .select('id, trip_code, trip_name, created_at')
                    .single();

                if (!error && data) return data;
                if (error && (error.code === '23505' || /duplicate key/i.test(error.message))) {
                    continue;
                }
                throw error || new Error('Failed to create trip.');
            }

            throw new Error('Could not generate a unique trip code. Please try again.');
        }

        async function fetchTripByCode(tripCode) {
            const code = normalizeTripCode(tripCode);
            if (!code || code.length < 6) return null;

            const { data, error } = await supabaseClient
                .from('trips')
                .select('id, trip_code, trip_name, created_at')
                .eq('trip_code', code)
                .maybeSingle();

            if (error) throw error;
            return data || null;
        }

        async function enterTrip(tripRow) {
            persistCurrentTrip(tripRow);

            // Reset in-memory state for the selected trip, then load namespaced storage.
            crewMembers = [];
            expenses = [];
            activities = [];
            loadData();
            showApp();
        }

        async function resumeTripIfPossible() {
            const persisted = readPersistedTrip();
            if (!persisted) return false;

            try {
                const tripRow = await fetchTripByCode(persisted.trip_code);
                if (!tripRow) {
                    clearPersistedTrip();
                    return false;
                }
                await enterTrip(tripRow);
                return true;
            } catch {
                // If Supabase is unreachable, fall back to the persisted info so the app can still be used.
                currentTrip = persisted;
                storageKeyPrefix = `vegas_${persisted.trip_code}_`;
                crewMembers = [];
                expenses = [];
                activities = [];
                loadData();
                showApp();
                return true;
            }
        }

        async function handleCreateTrip() {
            const btn = document.getElementById('createTripBtn');
            setLandingError('');
            setBusy(btn, true, 'Creating...');

            try {
                const tripName = document.getElementById('createTripName').value;
                const tripRow = await createTrip(tripName);
                showCrewForm(tripRow, true);
            } catch (e) {
                setLandingError(e?.message || 'Could not create trip. Please try again.');
            } finally {
                setBusy(btn, false);
            }
        }

        async function handleJoinTrip() {
            const btn = document.getElementById('joinTripBtn');
            setLandingError('');
            setBusy(btn, true, 'Joining...');

            try {
                const code = document.getElementById('joinTripCode').value;
                const tripRow = await fetchTripByCode(code);
                if (!tripRow) {
                    setLandingError('Trip code not found. Double-check the code and try again.');
                    return;
                }
                showJoinPreview(tripRow);
            } catch (e) {
                setLandingError(e?.message || 'Could not join trip. Please try again.');
            } finally {
                setBusy(btn, false);
            }
        }

        async function saveCrewAndEnterTrip() {
            const name = document.getElementById('crewName').value.trim();
            const email = document.getElementById('crewEmail').value.trim();
            const arrival_flight = document.getElementById('crewArrivalFlight').value.trim();
            const arrival_datetime = document.getElementById('crewArrivalDatetime').value || null;
            const departure_flight = document.getElementById('crewDepartureFlight').value.trim();
            const departure_datetime = document.getElementById('crewDepartureDatetime').value || null;

            if (!name || !email) {
                setCrewFormError('Name and email are required.');
                return;
            }
            if (!pendingJoinTrip?.trip_code) {
                setCrewFormError('Session expired. Please join the trip again.');
                return;
            }

            const btn = document.getElementById('crewFormSubmit');
            setCrewFormError('');
            setBusy(btn, true, 'Saving...');

            try {
                const { error } = await supabaseClient
                    .from('crew')
                    .insert({
                        trip_code: pendingJoinTrip.trip_code,
                        name,
                        email,
                        arrival_flight: arrival_flight || null,
                        arrival_datetime: arrival_datetime ? new Date(arrival_datetime).toISOString() : null,
                        departure_flight: departure_flight || null,
                        departure_datetime: departure_datetime ? new Date(departure_datetime).toISOString() : null
                    });
                if (error) throw error;
                const tripRow = pendingJoinTrip;
                hideCrewForm();
                await enterTrip(tripRow);
            } catch (e) {
                setCrewFormError(e?.message || 'Could not save. Please try again.');
            } finally {
                setBusy(btn, false);
            }
        }

        async function loadCrew() {
            const listEl = document.getElementById('crewList');
            if (!listEl || !currentTrip?.trip_code) return;

            listEl.innerHTML = '<li class="empty-state">Loading crew‚Ä¶</li>';
            try {
                const { data, error } = await supabaseClient
                    .from('crew')
                    .select('id, name, email, arrival_flight, arrival_datetime, departure_flight, departure_datetime')
                    .eq('trip_code', currentTrip.trip_code)
                    .order('name');
                if (error) throw error;
                crewMembers = data || [];
                renderCrew(crewMembers);
                updateExpensePersonOptions();
                renderBalances();
            } catch (e) {
                listEl.innerHTML = '<li class="empty-state">Could not load crew. Try again later.</li>';
                crewMembers = [];
                updateExpensePersonOptions();
                renderBalances();
            }
        }

        function renderCrew(crew) {
            const listEl = document.getElementById('crewList');
            if (!listEl) return;

            if (!crew.length) {
                listEl.innerHTML = '<li class="empty-state">No crew members yet. Join with the trip code to add yourself.</li>';
                return;
            }

            function formatDt(iso) {
                if (!iso) return '';
                try {
                    const d = new Date(iso);
                    return d.toLocaleString('en-US', {
                        weekday: 'short', month: 'short', day: 'numeric',
                        hour: 'numeric', minute: '2-digit'
                    });
                } catch {
                    return iso;
                }
            }

            listEl.innerHTML = crew.map(c => {
                const parts = [];
                if (c.arrival_flight || c.arrival_datetime) {
                    parts.push('Arrive: ' + [c.arrival_flight, formatDt(c.arrival_datetime)].filter(Boolean).join(' ¬∑ '));
                }
                if (c.departure_flight || c.departure_datetime) {
                    parts.push('Depart: ' + [c.departure_flight, formatDt(c.departure_datetime)].filter(Boolean).join(' ¬∑ '));
                }
                const id = c.id == null ? '' : String(c.id);
                return `
                    <li data-crew-id="${escapeHtml(id)}">
                        <div class="crew-name">${escapeHtml(c.name)}</div>
                        <div class="crew-detail">${escapeHtml(c.email)}</div>
                        ${parts.length ? parts.map(p => `<div class="crew-detail">${escapeHtml(p)}</div>`).join('') : ''}
                        <div class="crew-item-actions">
                            <button type="button" class="btn-secondary" onclick="openCrewMemberModal(this.closest('li').dataset.crewId)">Edit</button>
                            <button type="button" class="btn-danger" onclick="deleteCrewMember(this.closest('li').dataset.crewId)">Delete</button>
                        </div>
                    </li>
                `;
            }).join('');
        }

        function updateExpensePersonOptions() {
            const payer = document.getElementById('expensePayer');
            const splitGroup = document.getElementById('splitBetween');
            if (!payer || !splitGroup) return;

            const names = crewMembers.map(c => c.name);
            if (names.length === 0) {
                payer.innerHTML = '<option value="">Who paid?</option>';
                splitGroup.innerHTML = '<span class="muted" style="font-size: 0.9rem;">Add crew members to split expenses.</span>';
                return;
            }
            payer.innerHTML = '<option value="">Who paid?</option>' +
                names.map(n => `<option value="${escapeHtml(n)}">${escapeHtml(n)}</option>`).join('');
            splitGroup.innerHTML = names.map(n => `
                <label>
                    <input type="checkbox" value="${escapeHtml(n)}">
                    ${escapeHtml(n)}
                </label>
            `).join('');
        }

        function escapeHtml(s) {
            if (s == null) return '';
            const div = document.createElement('div');
            div.textContent = s;
            return div.innerHTML;
        }

        function isoToDatetimeLocal(iso) {
            if (!iso) return '';
            try {
                const d = new Date(iso);
                const y = d.getFullYear();
                const m = String(d.getMonth() + 1).padStart(2, '0');
                const day = String(d.getDate()).padStart(2, '0');
                const h = String(d.getHours()).padStart(2, '0');
                const min = String(d.getMinutes()).padStart(2, '0');
                return `${y}-${m}-${day}T${h}:${min}`;
            } catch {
                return '';
            }
        }

        function openCrewMemberModal(crewId) {
            const modal = document.getElementById('crewMemberModal');
            const titleEl = document.getElementById('crewModalTitle');
            const idInput = document.getElementById('crewMemberId');
            const form = document.getElementById('crewMemberForm');
            if (!modal || !titleEl || !idInput || !form) return;

            setCrewMemberModalError('');
            form.reset();
            idInput.value = '';

            if (crewId) {
                const member = crewMembers.find(c => String(c.id) === String(crewId));
                if (member) {
                    titleEl.textContent = 'Edit Crew Member';
                    idInput.value = String(member.id);
                    document.getElementById('modalCrewName').value = member.name || '';
                    document.getElementById('modalCrewEmail').value = member.email || '';
                    document.getElementById('modalCrewArrivalFlight').value = member.arrival_flight || '';
                    document.getElementById('modalCrewArrivalDatetime').value = isoToDatetimeLocal(member.arrival_datetime);
                    document.getElementById('modalCrewDepartureFlight').value = member.departure_flight || '';
                    document.getElementById('modalCrewDepartureDatetime').value = isoToDatetimeLocal(member.departure_datetime);
                }
            } else {
                titleEl.textContent = 'Add Crew Member';
            }
            modal.style.display = 'flex';
        }

        function closeCrewMemberModal() {
            const modal = document.getElementById('crewMemberModal');
            if (modal) modal.style.display = 'none';
        }

        function setCrewMemberModalError(message) {
            const el = document.getElementById('crewMemberModalError');
            if (!el) return;
            if (!message) {
                el.style.display = 'none';
                el.textContent = '';
                return;
            }
            el.style.display = 'block';
            el.textContent = message;
        }

        async function saveCrewMember() {
            const idInput = document.getElementById('crewMemberId');
            const id = (idInput && idInput.value) ? idInput.value.trim() : null;
            const name = document.getElementById('modalCrewName').value.trim();
            const email = document.getElementById('modalCrewEmail').value.trim();
            const arrival_flight = document.getElementById('modalCrewArrivalFlight').value.trim();
            const arrival_datetime = document.getElementById('modalCrewArrivalDatetime').value || null;
            const departure_flight = document.getElementById('modalCrewDepartureFlight').value.trim();
            const departure_datetime = document.getElementById('modalCrewDepartureDatetime').value || null;

            if (!name || !email) {
                setCrewMemberModalError('Name and email are required.');
                return;
            }
            if (!currentTrip?.trip_code) {
                setCrewMemberModalError('No trip selected.');
                return;
            }

            const btn = document.getElementById('crewMemberModalSubmit');
            setCrewMemberModalError('');
            setBusy(btn, true, 'Saving...');

            try {
                const payload = {
                    name,
                    email,
                    arrival_flight: arrival_flight || null,
                    arrival_datetime: arrival_datetime ? new Date(arrival_datetime).toISOString() : null,
                    departure_flight: departure_flight || null,
                    departure_datetime: departure_datetime ? new Date(departure_datetime).toISOString() : null
                };
                if (id) {
                    const { error } = await supabaseClient
                        .from('crew')
                        .update(payload)
                        .eq('id', id);
                    if (error) throw error;
                } else {
                    const { error } = await supabaseClient
                        .from('crew')
                        .insert({ trip_code: currentTrip.trip_code, ...payload });
                    if (error) throw error;
                }
                closeCrewMemberModal();
                await loadCrew();
            } catch (e) {
                setCrewMemberModalError(e?.message || 'Could not save. Please try again.');
            } finally {
                setBusy(btn, false);
            }
        }

        async function deleteCrewMember(crewId) {
            if (!crewId || !currentTrip?.trip_code) return;
            if (!confirm('Remove this crew member from the trip? Expenses that reference them will still show their name.')) return;

            try {
                const { error } = await supabaseClient
                    .from('crew')
                    .delete()
                    .eq('id', crewId)
                    .eq('trip_code', currentTrip.trip_code);
                if (error) throw error;
                await loadCrew();
            } catch (e) {
                alert(e?.message || 'Could not delete. Please try again.');
            }
        }

        function switchTrip() {
            clearPersistedTrip();
            showLanding();
        }

        // Data storage (crew is loaded from Supabase; expenses and activities are local)
        let crewMembers = [];
        let expenses = [];
        let activities = [];

        // Load from localStorage
        function loadData() {
            if (!storageKeyPrefix) return;

            const savedExpenses = localStorage.getItem(storageKeyPrefix + 'expenses');
            const savedActivities = localStorage.getItem(storageKeyPrefix + 'activities');

            if (savedExpenses) expenses = JSON.parse(savedExpenses);
            if (savedActivities) activities = JSON.parse(savedActivities);

            renderAll();
        }

        // Save to localStorage
        function saveData() {
            if (!storageKeyPrefix) return;
            localStorage.setItem(storageKeyPrefix + 'expenses', JSON.stringify(expenses));
            localStorage.setItem(storageKeyPrefix + 'activities', JSON.stringify(activities));
        }

        // Add an activity
        function addActivity() {
            const name = document.getElementById('activityName').value.trim();
            const date = document.getElementById('activityDate').value;
            const time = document.getElementById('activityTime').value;
            const notes = document.getElementById('activityNotes').value.trim();

            if (name) {
                activities.push({ id: Date.now(), name, date, time, notes });
                document.getElementById('activityName').value = '';
                document.getElementById('activityDate').value = '';
                document.getElementById('activityTime').value = '';
                document.getElementById('activityNotes').value = '';
                saveData();
                renderActivities();
            }
        }

        // Remove an activity
        function removeActivity(id) {
            activities = activities.filter(a => a.id !== id);
            saveData();
            renderActivities();
        }

        // Add an expense
        function addExpense() {
            const desc = document.getElementById('expenseDesc').value.trim();
            const amount = parseFloat(document.getElementById('expenseAmount').value);
            const payer = document.getElementById('expensePayer').value;
            const splitBetween = [...document.querySelectorAll('#splitBetween input:checked')]
                .map(cb => cb.value);

            if (desc && amount > 0 && payer && splitBetween.length > 0) {
                expenses.push({
                    id: Date.now(),
                    desc,
                    amount,
                    payer,
                    splitBetween
                });

                document.getElementById('expenseDesc').value = '';
                document.getElementById('expenseAmount').value = '';
                document.getElementById('expensePayer').value = '';
                document.querySelectorAll('#splitBetween input').forEach(cb => cb.checked = false);

                saveData();
                renderExpenses();
                renderBalances();
            }
        }

        // Remove an expense
        function removeExpense(id) {
            expenses = expenses.filter(e => e.id !== id);
            saveData();
            renderExpenses();
            renderBalances();
        }

        // Calculate balances (using crew member names)
        function calculateBalances() {
            const balances = {};
            crewMembers.forEach(c => balances[c.name] = 0);

            expenses.forEach(expense => {
                const perPerson = expense.amount / expense.splitBetween.length;

                // Payer gets credit for the full amount
                if (balances.hasOwnProperty(expense.payer)) {
                    balances[expense.payer] += expense.amount;
                }

                // Everyone who benefits owes their share
                expense.splitBetween.forEach(person => {
                    if (balances.hasOwnProperty(person)) {
                        balances[person] -= perPerson;
                    }
                });
            });

            return balances;
        }

        // Calculate settlements (who pays whom)
        function calculateSettlements(balances) {
            const settlements = [];
            const debtors = [];
            const creditors = [];

            Object.entries(balances).forEach(([person, amount]) => {
                if (amount < -0.01) {
                    debtors.push({ person, amount: -amount });
                } else if (amount > 0.01) {
                    creditors.push({ person, amount });
                }
            });

            // Sort for optimal settlements
            debtors.sort((a, b) => b.amount - a.amount);
            creditors.sort((a, b) => b.amount - a.amount);

            let i = 0, j = 0;
            while (i < debtors.length && j < creditors.length) {
                const payment = Math.min(debtors[i].amount, creditors[j].amount);

                if (payment > 0.01) {
                    settlements.push({
                        from: debtors[i].person,
                        to: creditors[j].person,
                        amount: payment
                    });
                }

                debtors[i].amount -= payment;
                creditors[j].amount -= payment;

                if (debtors[i].amount < 0.01) i++;
                if (creditors[j].amount < 0.01) j++;
            }

            return settlements;
        }

        // Render functions
        function renderExpenses() {
            const list = document.getElementById('expenseList');

            if (expenses.length === 0) {
                list.innerHTML = '<li class="empty-state">No expenses recorded yet</li>';
                return;
            }

            list.innerHTML = expenses.map(e => `
                <li>
                    <div class="expense-header">
                        <span class="expense-amount">$${e.amount.toFixed(2)}</span>
                        <button class="btn-danger" onclick="removeExpense(${e.id})">Remove</button>
                    </div>
                    <strong>${e.desc}</strong>
                    <div class="expense-details">
                        Paid by <strong>${e.payer}</strong> ¬∑ Split between ${e.splitBetween.join(', ')}
                    </div>
                </li>
            `).join('');
        }

        function renderActivities() {
            const list = document.getElementById('activityList');

            if (activities.length === 0) {
                list.innerHTML = '<li class="empty-state">No activities planned yet</li>';
                return;
            }

            // Sort by date and time
            const sorted = [...activities].sort((a, b) => {
                const dateA = a.date + a.time;
                const dateB = b.date + b.time;
                return dateA.localeCompare(dateB);
            });

            list.innerHTML = sorted.map(a => {
                const dateStr = a.date ? new Date(a.date + 'T12:00').toLocaleDateString('en-US', {
                    weekday: 'short', month: 'short', day: 'numeric'
                }) : '';
                const timeStr = a.time ? new Date('2000-01-01T' + a.time).toLocaleTimeString('en-US', {
                    hour: 'numeric', minute: '2-digit'
                }) : '';

                return `
                    <li>
                        <div class="activity-item">
                            <span class="activity-name">${a.name}</span>
                            ${dateStr || timeStr ? `<span class="activity-date">${dateStr} ${timeStr}</span>` : ''}
                            ${a.notes ? `<span class="activity-notes">${a.notes}</span>` : ''}
                        </div>
                        <button class="btn-danger" onclick="removeActivity(${a.id})">Remove</button>
                    </li>
                `;
            }).join('');
        }

        function renderBalances() {
            const grid = document.getElementById('balanceGrid');
            const settlementsDiv = document.getElementById('settlements');
            const settlementList = document.getElementById('settlementList');
            const totalSpent = document.getElementById('totalSpent');

            const total = expenses.reduce((sum, e) => sum + e.amount, 0);
            totalSpent.textContent = '$' + total.toFixed(2);

            if (crewMembers.length === 0 || expenses.length === 0) {
                grid.innerHTML = '<div class="empty-state">Add crew and expenses to see balances</div>';
                settlementsDiv.style.display = 'none';
                return;
            }

            const balances = calculateBalances();

            grid.innerHTML = Object.entries(balances).map(([person, amount]) => {
                let status, label;
                if (amount > 0.01) {
                    status = 'positive';
                    label = 'gets back';
                } else if (amount < -0.01) {
                    status = 'negative';
                    label = 'owes';
                } else {
                    status = 'zero';
                    label = 'settled';
                }

                return `
                    <div class="balance-item">
                        <div class="person">${person}</div>
                        <div class="amount ${status}">
                            ${status === 'zero' ? 'All settled!' : `${label} $${Math.abs(amount).toFixed(2)}`}
                        </div>
                    </div>
                `;
            }).join('');

            const settlements = calculateSettlements(balances);

            if (settlements.length > 0) {
                settlementsDiv.style.display = 'block';
                settlementList.innerHTML = settlements.map(s => `
                    <div class="settlement-item">
                        <strong>${s.from}</strong>
                        <span class="arrow">‚Üí</span>
                        <strong>${s.to}</strong>
                        <span style="margin-left: auto; color: #2ecc71; font-weight: 600;">$${s.amount.toFixed(2)}</span>
                    </div>
                `).join('');
            } else {
                settlementsDiv.style.display = 'none';
            }
        }

        function renderAll() {
            renderExpenses();
            renderActivities();
            renderBalances();
            updateExpensePersonOptions();
        }

        // Event listeners
        function initUI() {
            const createBtn = document.getElementById('createTripBtn');
            const joinBtn = document.getElementById('joinTripBtn');
            const joinCode = document.getElementById('joinTripCode');
            const createName = document.getElementById('createTripName');

            if (createBtn) createBtn.addEventListener('click', handleCreateTrip);
            if (joinBtn) joinBtn.addEventListener('click', handleJoinTrip);
            if (joinCode) {
                joinCode.addEventListener('input', () => setLandingError(''));
                joinCode.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') handleJoinTrip();
                });
            }
            if (createName) {
                createName.addEventListener('input', () => setLandingError(''));
                createName.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') handleCreateTrip();
                });
            }

            const crewForm = document.getElementById('crewForm');
            if (crewForm) {
                crewForm.addEventListener('submit', (e) => {
                    e.preventDefault();
                    saveCrewAndEnterTrip();
                });
            }
        }

        async function init() {
            initUI();
            const resumed = await resumeTripIfPossible();
            if (!resumed) showLanding();
        }

        init();
    </script>
</body>
</html>
