<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vegas Trip Planner</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            min-height: 100vh;
            color: #fff;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            text-align: center;
            padding: 40px 0;
        }

        header h1 {
            font-size: 3rem;
            background: linear-gradient(90deg, #f9d423, #ff4e50);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 10px;
        }

        header p {
            color: #aaa;
            font-size: 1.1rem;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 16px;
            padding: 24px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .card h2 {
            font-size: 1.4rem;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .card h2 span {
            font-size: 1.5rem;
        }

        input, select, textarea {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
            font-size: 1rem;
            margin-bottom: 12px;
        }

        input::placeholder, textarea::placeholder {
            color: rgba(255, 255, 255, 0.5);
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #f9d423;
        }

        button {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        button:hover {
            transform: translateY(-2px);
        }

        .btn-primary {
            background: linear-gradient(90deg, #f9d423, #ff4e50);
            color: #1a1a2e;
            font-weight: 600;
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .btn-danger {
            background: #e74c3c;
            color: #fff;
            padding: 6px 12px;
            font-size: 0.85rem;
        }

        .friend-list, .expense-list, .activity-list {
            list-style: none;
            margin-top: 16px;
        }

        .friend-list li, .expense-list li, .activity-list li {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            margin-bottom: 8px;
        }

        .friend-list li .name {
            font-weight: 500;
        }

        .expense-list li {
            flex-direction: column;
            align-items: flex-start;
            gap: 8px;
        }

        .expense-header {
            display: flex;
            justify-content: space-between;
            width: 100%;
            align-items: center;
        }

        .expense-details {
            font-size: 0.9rem;
            color: #aaa;
        }

        .expense-amount {
            font-size: 1.2rem;
            font-weight: 600;
            color: #2ecc71;
        }

        .balance-card {
            grid-column: 1 / -1;
        }

        .balance-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 16px;
            margin-top: 16px;
        }

        .balance-item {
            background: rgba(255, 255, 255, 0.05);
            padding: 16px;
            border-radius: 8px;
            text-align: center;
        }

        .balance-item .person {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .balance-item .amount {
            font-size: 1.5rem;
            font-weight: 700;
        }

        .balance-item .amount.positive {
            color: #2ecc71;
        }

        .balance-item .amount.negative {
            color: #e74c3c;
        }

        .balance-item .amount.zero {
            color: #f9d423;
        }

        .settlements {
            margin-top: 24px;
            padding-top: 24px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .settlements h3 {
            margin-bottom: 16px;
            color: #f9d423;
        }

        .settlement-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            background: rgba(46, 204, 113, 0.1);
            border-radius: 8px;
            margin-bottom: 8px;
            border-left: 4px solid #2ecc71;
        }

        .settlement-item .arrow {
            color: #2ecc71;
            font-weight: bold;
        }

        .checkbox-group {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 12px;
        }

        .checkbox-group label {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 8px 12px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 6px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .checkbox-group label:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .checkbox-group input[type="checkbox"] {
            width: auto;
            margin: 0;
        }

        .activity-item {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .activity-item .activity-name {
            font-weight: 500;
        }

        .activity-item .activity-date {
            font-size: 0.85rem;
            color: #aaa;
        }

        .activity-item .activity-notes {
            font-size: 0.9rem;
            color: #ccc;
            font-style: italic;
        }

        .empty-state {
            text-align: center;
            padding: 24px;
            color: #666;
        }

        .input-row {
            display: flex;
            gap: 12px;
        }

        .input-row input {
            flex: 1;
        }

        .total-spent {
            text-align: center;
            padding: 20px;
            background: linear-gradient(90deg, rgba(249, 212, 35, 0.1), rgba(255, 78, 80, 0.1));
            border-radius: 12px;
            margin-bottom: 20px;
        }

        .total-spent .label {
            font-size: 0.9rem;
            color: #aaa;
            margin-bottom: 4px;
        }

        .total-spent .value {
            font-size: 2.5rem;
            font-weight: 700;
            background: linear-gradient(90deg, #f9d423, #ff4e50);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        @media (max-width: 768px) {
            header h1 {
                font-size: 2rem;
            }

            .grid {
                grid-template-columns: 1fr;
            }

            .input-row {
                flex-direction: column;
            }
        }

        /* Trip landing + header meta */
        .screen {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .landing-wrap {
            width: 100%;
            max-width: 860px;
        }

        .landing-title {
            text-align: center;
            margin-bottom: 20px;
        }

        .landing-title h1 {
            font-size: 3rem;
            background: linear-gradient(90deg, #f9d423, #ff4e50);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 10px;
        }

        .landing-title p {
            color: #aaa;
            font-size: 1.05rem;
        }

        .landing-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 16px;
        }

        .muted {
            color: #aaa;
            font-size: 0.95rem;
        }

        .error {
            margin-top: 10px;
            background: rgba(231, 76, 60, 0.12);
            border: 1px solid rgba(231, 76, 60, 0.35);
            color: #ffd7d3;
            padding: 10px 12px;
            border-radius: 8px;
            display: none;
        }

        .trip-meta {
            margin-top: 14px;
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 10px;
        }

        .pill {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            border-radius: 999px;
            background: rgba(255, 255, 255, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.14);
            color: #fff;
            font-size: 0.95rem;
        }

        .pill code {
            font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
            letter-spacing: 0.08em;
            font-weight: 700;
        }

        .btn-small {
            padding: 8px 12px;
            font-size: 0.95rem;
        }
    </style>
</head>
<body>
    <!-- Landing screen (Create/Join Trip) -->
    <div id="landingRoot" class="screen">
        <div class="landing-wrap">
            <div class="landing-title">
                <h1>Vegas Trip Planner</h1>
                <p>Create a trip or join with a code to get started.</p>
            </div>

            <div class="landing-grid">
                <div class="card">
                    <h2><span>‚ú®</span> Create Trip</h2>
                    <input id="createTripName" type="text" placeholder="Trip name (e.g., Vegas 2026)">
                    <button id="createTripBtn" class="btn-primary" style="width: 100%;">Create Trip</button>
                    <div class="muted" style="margin-top: 10px;">
                        You‚Äôll get a 6-character code to share with friends.
                    </div>
                </div>

                <div class="card">
                    <h2><span>üîë</span> Join Trip</h2>
                    <input id="joinTripCode" type="text" placeholder="Enter code (e.g., A1B2C3)" maxlength="12" autocapitalize="characters" spellcheck="false">
                    <button id="joinTripBtn" class="btn-secondary" style="width: 100%;">Join Trip</button>
                    <div class="muted" style="margin-top: 10px;">
                        Codes are not case-sensitive.
                    </div>
                </div>
            </div>

            <div id="landingError" class="error"></div>
        </div>
    </div>

    <!-- Main app (shown after trip is selected) -->
    <div id="appRoot" style="display: none;">
        <div class="container">
            <header>
                <h1>Vegas Trip Planner</h1>
                <p>Plan your trip and split expenses fairly</p>
                <div class="trip-meta">
                    <span class="pill">Trip: <strong id="tripNameDisplay">‚Äî</strong></span>
                    <span class="pill">Code: <code id="tripCodeDisplay">------</code></span>
                    <button class="btn-secondary btn-small" onclick="switchTrip()">Switch Trip</button>
                </div>
            </header>

            <div class="grid">
                <!-- Friends Section -->
                <div class="card">
                    <h2><span>üë•</span> Friends</h2>
                    <div class="input-row">
                        <input type="text" id="friendName" placeholder="Enter friend's name">
                        <button class="btn-primary" onclick="addFriend()">Add</button>
                    </div>
                    <ul class="friend-list" id="friendList">
                        <li class="empty-state">Add friends to get started</li>
                    </ul>
                </div>

                <!-- Activities Section -->
                <div class="card">
                    <h2><span>üé∞</span> Activities</h2>
                    <input type="text" id="activityName" placeholder="Activity name (e.g., Cirque du Soleil)">
                    <div class="input-row">
                        <input type="date" id="activityDate">
                        <input type="time" id="activityTime">
                    </div>
                    <textarea id="activityNotes" placeholder="Notes (optional)" rows="2"></textarea>
                    <button class="btn-primary" onclick="addActivity()">Add Activity</button>
                    <ul class="activity-list" id="activityList">
                        <li class="empty-state">No activities planned yet</li>
                    </ul>
                </div>

                <!-- Expenses Section -->
                <div class="card">
                    <h2><span>üí∞</span> Add Expense</h2>
                    <input type="text" id="expenseDesc" placeholder="What was it for? (e.g., Hotel, Show tickets)">
                    <input type="number" id="expenseAmount" placeholder="Amount ($)" step="0.01">
                    <select id="expensePayer">
                        <option value="">Who paid?</option>
                    </select>
                    <p style="margin-bottom: 8px; color: #aaa; font-size: 0.9rem;">Split between:</p>
                    <div class="checkbox-group" id="splitBetween"></div>
                    <button class="btn-primary" onclick="addExpense()">Add Expense</button>
                </div>

                <!-- Expense List -->
                <div class="card">
                    <h2><span>üìã</span> Expenses</h2>
                    <ul class="expense-list" id="expenseList">
                        <li class="empty-state">No expenses recorded yet</li>
                    </ul>
                </div>

                <!-- Balance Section -->
                <div class="card balance-card">
                    <h2><span>‚öñÔ∏è</span> Balances</h2>
                    <div class="total-spent">
                        <div class="label">Total Trip Cost</div>
                        <div class="value" id="totalSpent">$0.00</div>
                    </div>
                    <div class="balance-grid" id="balanceGrid">
                        <div class="empty-state">Add friends and expenses to see balances</div>
                    </div>
                    <div class="settlements" id="settlements" style="display: none;">
                        <h3>How to Settle Up</h3>
                        <div id="settlementList"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        // -----------------------------
        // Supabase + Trip gating
        // -----------------------------
        const SUPABASE_URL = 'https://sxjtepymbfqvcuzdsycj.supabase.co';
        const SUPABASE_ANON_KEY = 'sb_publishable_2d9L28Wc3gz7-u2jCIGU0A_bNrdJs9r';
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        const CURRENT_TRIP_STORAGE_KEY = 'vegas_current_trip';
        const CODE_ALPHABET = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
        let currentTrip = null;
        let storageKeyPrefix = null;

        function normalizeTripCode(input) {
            return String(input || '').trim().toUpperCase().replace(/\s+/g, '');
        }

        function generateTripCode() {
            const bytes = new Uint8Array(6);
            crypto.getRandomValues(bytes);
            let out = '';
            for (let i = 0; i < bytes.length; i++) {
                out += CODE_ALPHABET[bytes[i] % CODE_ALPHABET.length];
            }
            return out;
        }

        function setLandingError(message) {
            const el = document.getElementById('landingError');
            if (!el) return;
            if (!message) {
                el.style.display = 'none';
                el.textContent = '';
                return;
            }
            el.style.display = 'block';
            el.textContent = message;
        }

        function setBusy(btn, busy, busyText = 'Working...') {
            if (!btn) return;
            btn.disabled = !!busy;
            btn.dataset._prevText = btn.dataset._prevText || btn.textContent;
            btn.textContent = busy ? busyText : btn.dataset._prevText;
        }

        function persistCurrentTrip(tripRow) {
            currentTrip = tripRow;
            storageKeyPrefix = `vegas_${currentTrip.trip_code}_`;
            localStorage.setItem(CURRENT_TRIP_STORAGE_KEY, JSON.stringify({
                id: tripRow.id,
                trip_code: tripRow.trip_code,
                trip_name: tripRow.trip_name
            }));
        }

        function readPersistedTrip() {
            try {
                const raw = localStorage.getItem(CURRENT_TRIP_STORAGE_KEY);
                if (!raw) return null;
                const parsed = JSON.parse(raw);
                if (!parsed || !parsed.trip_code) return null;
                return parsed;
            } catch {
                return null;
            }
        }

        function clearPersistedTrip() {
            localStorage.removeItem(CURRENT_TRIP_STORAGE_KEY);
            currentTrip = null;
            storageKeyPrefix = null;
        }

        function showLanding() {
            setLandingError('');
            document.getElementById('landingRoot').style.display = 'flex';
            document.getElementById('appRoot').style.display = 'none';
        }

        function showApp() {
            document.getElementById('landingRoot').style.display = 'none';
            document.getElementById('appRoot').style.display = 'block';

            document.getElementById('tripNameDisplay').textContent = currentTrip?.trip_name || '‚Äî';
            document.getElementById('tripCodeDisplay').textContent = currentTrip?.trip_code || '------';
        }

        async function createTrip(tripName) {
            const name = String(tripName || '').trim() || 'Vegas Trip';

            // Retry on rare collisions against unique constraint.
            for (let attempt = 0; attempt < 10; attempt++) {
                const code = generateTripCode();
                const { data, error } = await supabaseClient
                    .from('trips')
                    .insert({ trip_code: code, trip_name: name })
                    .select('id, trip_code, trip_name, created_at')
                    .single();

                if (!error && data) return data;
                if (error && (error.code === '23505' || /duplicate key/i.test(error.message))) {
                    continue;
                }
                throw error || new Error('Failed to create trip.');
            }

            throw new Error('Could not generate a unique trip code. Please try again.');
        }

        async function fetchTripByCode(tripCode) {
            const code = normalizeTripCode(tripCode);
            if (!code || code.length < 6) return null;

            const { data, error } = await supabaseClient
                .from('trips')
                .select('id, trip_code, trip_name, created_at')
                .eq('trip_code', code)
                .maybeSingle();

            if (error) throw error;
            return data || null;
        }

        async function enterTrip(tripRow) {
            persistCurrentTrip(tripRow);

            // Reset in-memory state for the selected trip, then load namespaced storage.
            friends = [];
            expenses = [];
            activities = [];
            loadData();
            showApp();
        }

        async function resumeTripIfPossible() {
            const persisted = readPersistedTrip();
            if (!persisted) return false;

            try {
                const tripRow = await fetchTripByCode(persisted.trip_code);
                if (!tripRow) {
                    clearPersistedTrip();
                    return false;
                }
                await enterTrip(tripRow);
                return true;
            } catch {
                // If Supabase is unreachable, fall back to the persisted info so the app can still be used.
                currentTrip = persisted;
                storageKeyPrefix = `vegas_${persisted.trip_code}_`;
                friends = [];
                expenses = [];
                activities = [];
                loadData();
                showApp();
                return true;
            }
        }

        async function handleCreateTrip() {
            const btn = document.getElementById('createTripBtn');
            setLandingError('');
            setBusy(btn, true, 'Creating...');

            try {
                const tripName = document.getElementById('createTripName').value;
                const tripRow = await createTrip(tripName);
                await enterTrip(tripRow);
            } catch (e) {
                setLandingError(e?.message || 'Could not create trip. Please try again.');
            } finally {
                setBusy(btn, false);
            }
        }

        async function handleJoinTrip() {
            const btn = document.getElementById('joinTripBtn');
            setLandingError('');
            setBusy(btn, true, 'Joining...');

            try {
                const code = document.getElementById('joinTripCode').value;
                const tripRow = await fetchTripByCode(code);
                if (!tripRow) {
                    setLandingError('Trip code not found. Double-check the code and try again.');
                    return;
                }
                await enterTrip(tripRow);
            } catch (e) {
                setLandingError(e?.message || 'Could not join trip. Please try again.');
            } finally {
                setBusy(btn, false);
            }
        }

        function switchTrip() {
            clearPersistedTrip();
            showLanding();
        }

        // Data storage
        let friends = [];
        let expenses = [];
        let activities = [];

        // Load from localStorage
        function loadData() {
            if (!storageKeyPrefix) return;

            const savedFriends = localStorage.getItem(storageKeyPrefix + 'friends');
            const savedExpenses = localStorage.getItem(storageKeyPrefix + 'expenses');
            const savedActivities = localStorage.getItem(storageKeyPrefix + 'activities');

            if (savedFriends) friends = JSON.parse(savedFriends);
            if (savedExpenses) expenses = JSON.parse(savedExpenses);
            if (savedActivities) activities = JSON.parse(savedActivities);

            renderAll();
        }

        // Save to localStorage
        function saveData() {
            if (!storageKeyPrefix) return;
            localStorage.setItem(storageKeyPrefix + 'friends', JSON.stringify(friends));
            localStorage.setItem(storageKeyPrefix + 'expenses', JSON.stringify(expenses));
            localStorage.setItem(storageKeyPrefix + 'activities', JSON.stringify(activities));
        }

        // Add a friend
        function addFriend() {
            const input = document.getElementById('friendName');
            const name = input.value.trim();

            if (name && !friends.includes(name)) {
                friends.push(name);
                input.value = '';
                saveData();
                renderAll();
            }
        }

        // Remove a friend
        function removeFriend(name) {
            friends = friends.filter(f => f !== name);
            expenses = expenses.filter(e => e.payer !== name);
            expenses.forEach(e => {
                e.splitBetween = e.splitBetween.filter(p => p !== name);
            });
            saveData();
            renderAll();
        }

        // Add an activity
        function addActivity() {
            const name = document.getElementById('activityName').value.trim();
            const date = document.getElementById('activityDate').value;
            const time = document.getElementById('activityTime').value;
            const notes = document.getElementById('activityNotes').value.trim();

            if (name) {
                activities.push({ id: Date.now(), name, date, time, notes });
                document.getElementById('activityName').value = '';
                document.getElementById('activityDate').value = '';
                document.getElementById('activityTime').value = '';
                document.getElementById('activityNotes').value = '';
                saveData();
                renderActivities();
            }
        }

        // Remove an activity
        function removeActivity(id) {
            activities = activities.filter(a => a.id !== id);
            saveData();
            renderActivities();
        }

        // Add an expense
        function addExpense() {
            const desc = document.getElementById('expenseDesc').value.trim();
            const amount = parseFloat(document.getElementById('expenseAmount').value);
            const payer = document.getElementById('expensePayer').value;
            const splitBetween = [...document.querySelectorAll('#splitBetween input:checked')]
                .map(cb => cb.value);

            if (desc && amount > 0 && payer && splitBetween.length > 0) {
                expenses.push({
                    id: Date.now(),
                    desc,
                    amount,
                    payer,
                    splitBetween
                });

                document.getElementById('expenseDesc').value = '';
                document.getElementById('expenseAmount').value = '';
                document.getElementById('expensePayer').value = '';
                document.querySelectorAll('#splitBetween input').forEach(cb => cb.checked = false);

                saveData();
                renderExpenses();
                renderBalances();
            }
        }

        // Remove an expense
        function removeExpense(id) {
            expenses = expenses.filter(e => e.id !== id);
            saveData();
            renderExpenses();
            renderBalances();
        }

        // Calculate balances
        function calculateBalances() {
            const balances = {};
            friends.forEach(f => balances[f] = 0);

            expenses.forEach(expense => {
                const perPerson = expense.amount / expense.splitBetween.length;

                // Payer gets credit for the full amount
                if (balances.hasOwnProperty(expense.payer)) {
                    balances[expense.payer] += expense.amount;
                }

                // Everyone who benefits owes their share
                expense.splitBetween.forEach(person => {
                    if (balances.hasOwnProperty(person)) {
                        balances[person] -= perPerson;
                    }
                });
            });

            return balances;
        }

        // Calculate settlements (who pays whom)
        function calculateSettlements(balances) {
            const settlements = [];
            const debtors = [];
            const creditors = [];

            Object.entries(balances).forEach(([person, amount]) => {
                if (amount < -0.01) {
                    debtors.push({ person, amount: -amount });
                } else if (amount > 0.01) {
                    creditors.push({ person, amount });
                }
            });

            // Sort for optimal settlements
            debtors.sort((a, b) => b.amount - a.amount);
            creditors.sort((a, b) => b.amount - a.amount);

            let i = 0, j = 0;
            while (i < debtors.length && j < creditors.length) {
                const payment = Math.min(debtors[i].amount, creditors[j].amount);

                if (payment > 0.01) {
                    settlements.push({
                        from: debtors[i].person,
                        to: creditors[j].person,
                        amount: payment
                    });
                }

                debtors[i].amount -= payment;
                creditors[j].amount -= payment;

                if (debtors[i].amount < 0.01) i++;
                if (creditors[j].amount < 0.01) j++;
            }

            return settlements;
        }

        // Render functions
        function renderFriends() {
            const list = document.getElementById('friendList');
            const payer = document.getElementById('expensePayer');
            const splitGroup = document.getElementById('splitBetween');

            if (friends.length === 0) {
                list.innerHTML = '<li class="empty-state">Add friends to get started</li>';
                payer.innerHTML = '<option value="">Who paid?</option>';
                splitGroup.innerHTML = '';
                return;
            }

            list.innerHTML = friends.map(f => `
                <li>
                    <span class="name">${f}</span>
                    <button class="btn-danger" onclick="removeFriend('${f}')">Remove</button>
                </li>
            `).join('');

            payer.innerHTML = '<option value="">Who paid?</option>' +
                friends.map(f => `<option value="${f}">${f}</option>`).join('');

            splitGroup.innerHTML = friends.map(f => `
                <label>
                    <input type="checkbox" value="${f}">
                    ${f}
                </label>
            `).join('');
        }

        function renderExpenses() {
            const list = document.getElementById('expenseList');

            if (expenses.length === 0) {
                list.innerHTML = '<li class="empty-state">No expenses recorded yet</li>';
                return;
            }

            list.innerHTML = expenses.map(e => `
                <li>
                    <div class="expense-header">
                        <span class="expense-amount">$${e.amount.toFixed(2)}</span>
                        <button class="btn-danger" onclick="removeExpense(${e.id})">Remove</button>
                    </div>
                    <strong>${e.desc}</strong>
                    <div class="expense-details">
                        Paid by <strong>${e.payer}</strong> ¬∑ Split between ${e.splitBetween.join(', ')}
                    </div>
                </li>
            `).join('');
        }

        function renderActivities() {
            const list = document.getElementById('activityList');

            if (activities.length === 0) {
                list.innerHTML = '<li class="empty-state">No activities planned yet</li>';
                return;
            }

            // Sort by date and time
            const sorted = [...activities].sort((a, b) => {
                const dateA = a.date + a.time;
                const dateB = b.date + b.time;
                return dateA.localeCompare(dateB);
            });

            list.innerHTML = sorted.map(a => {
                const dateStr = a.date ? new Date(a.date + 'T12:00').toLocaleDateString('en-US', {
                    weekday: 'short', month: 'short', day: 'numeric'
                }) : '';
                const timeStr = a.time ? new Date('2000-01-01T' + a.time).toLocaleTimeString('en-US', {
                    hour: 'numeric', minute: '2-digit'
                }) : '';

                return `
                    <li>
                        <div class="activity-item">
                            <span class="activity-name">${a.name}</span>
                            ${dateStr || timeStr ? `<span class="activity-date">${dateStr} ${timeStr}</span>` : ''}
                            ${a.notes ? `<span class="activity-notes">${a.notes}</span>` : ''}
                        </div>
                        <button class="btn-danger" onclick="removeActivity(${a.id})">Remove</button>
                    </li>
                `;
            }).join('');
        }

        function renderBalances() {
            const grid = document.getElementById('balanceGrid');
            const settlementsDiv = document.getElementById('settlements');
            const settlementList = document.getElementById('settlementList');
            const totalSpent = document.getElementById('totalSpent');

            const total = expenses.reduce((sum, e) => sum + e.amount, 0);
            totalSpent.textContent = '$' + total.toFixed(2);

            if (friends.length === 0 || expenses.length === 0) {
                grid.innerHTML = '<div class="empty-state">Add friends and expenses to see balances</div>';
                settlementsDiv.style.display = 'none';
                return;
            }

            const balances = calculateBalances();

            grid.innerHTML = Object.entries(balances).map(([person, amount]) => {
                let status, label;
                if (amount > 0.01) {
                    status = 'positive';
                    label = 'gets back';
                } else if (amount < -0.01) {
                    status = 'negative';
                    label = 'owes';
                } else {
                    status = 'zero';
                    label = 'settled';
                }

                return `
                    <div class="balance-item">
                        <div class="person">${person}</div>
                        <div class="amount ${status}">
                            ${status === 'zero' ? 'All settled!' : `${label} $${Math.abs(amount).toFixed(2)}`}
                        </div>
                    </div>
                `;
            }).join('');

            const settlements = calculateSettlements(balances);

            if (settlements.length > 0) {
                settlementsDiv.style.display = 'block';
                settlementList.innerHTML = settlements.map(s => `
                    <div class="settlement-item">
                        <strong>${s.from}</strong>
                        <span class="arrow">‚Üí</span>
                        <strong>${s.to}</strong>
                        <span style="margin-left: auto; color: #2ecc71; font-weight: 600;">$${s.amount.toFixed(2)}</span>
                    </div>
                `).join('');
            } else {
                settlementsDiv.style.display = 'none';
            }
        }

        function renderAll() {
            renderFriends();
            renderExpenses();
            renderActivities();
            renderBalances();
        }

        // Event listeners
        function initUI() {
            const friendInput = document.getElementById('friendName');
            if (friendInput) {
                friendInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') addFriend();
                });
            }

            const createBtn = document.getElementById('createTripBtn');
            const joinBtn = document.getElementById('joinTripBtn');
            const joinCode = document.getElementById('joinTripCode');
            const createName = document.getElementById('createTripName');

            if (createBtn) createBtn.addEventListener('click', handleCreateTrip);
            if (joinBtn) joinBtn.addEventListener('click', handleJoinTrip);
            if (joinCode) {
                joinCode.addEventListener('input', () => setLandingError(''));
                joinCode.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') handleJoinTrip();
                });
            }
            if (createName) {
                createName.addEventListener('input', () => setLandingError(''));
                createName.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') handleCreateTrip();
                });
            }
        }

        async function init() {
            initUI();
            const resumed = await resumeTripIfPossible();
            if (!resumed) showLanding();
        }

        init();
    </script>
</body>
</html>
